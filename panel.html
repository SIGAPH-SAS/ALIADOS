<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panel Aliados | SIGAPH S.A.S.</title>

  <!-- Librerías -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    body {
      font-family: 'Poppins', Arial, sans-serif;
      margin: 0;
      background: #f4f7fb;
      color: #333;
      text-align: center;
    }
    header {
      background: #fff;
      color: #0a7b40;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .panel-logo img { height: 60px; margin-right: 12px; }
    nav {
      background: #0a7b40;
      padding: 10px;
      display: flex;
      justify-content: center;
      gap: 15px;
      flex-wrap: wrap;
    }
    nav button {
      background: #fff;
      color: #0a7b40;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.2s;
    }
    nav button:hover { background: #002b5c; color: #fff; }
    main { padding: 20px; max-width: 1100px; margin: auto; text-align: left; }
    section { display: none; margin-top: 20px; }
    section.activo { display: block; }
    .logout-btn {
      background: #c0392b; color: #fff; border: none;
      padding: 8px 12px; border-radius: 6px;
      cursor: pointer; font-weight: bold;
    }
    .logout-btn:hover { background: #a12e22; }
    iframe {
      width: 100%; border: none; border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #e9f5ee; }
    #logoCentral { display: block; margin: 30px auto; height: 120px; }
    .center { text-align: center; }

    /* --- LÍNEA DE TIEMPO --- */
    .timeline-container { background:#fff; border-radius:12px; box-shadow:0 2px 12px rgba(0,0,0,0.1); padding:20px; }
    .timeline-tabs { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-bottom:10px; }
    .timeline-tab { background:#e9f5ee; border:none; border-radius:8px; padding:8px 14px; font-weight:600; cursor:pointer; transition:0.2s; }
    .timeline-tab.active { background:#0a7b40; color:#fff; transform:scale(1.05); }
    .timeline-step-small {
      width:26px; height:26px; border-radius:5px;
      line-height:26px; font-size:0.8rem;
      color:#fff; cursor:pointer; transition:0.2s; margin:2px;
    }
    .timeline-step-small:hover { transform:scale(1.1); }
    .timeline-compact { display:flex; flex-wrap:wrap; gap:4px; justify-content:center; margin:10px 0; }
    .timeline-controls select, .timeline-controls textarea {
      width:100%; padding:8px; border-radius:6px; border:1px solid #ccc; margin-bottom:6px;
    }
    .timeline-controls button {
      padding:8px; border:none; border-radius:6px;
      background:#0a7b40; color:#fff; font-weight:600; cursor:pointer;
    }
    .timeline-controls button:hover { background:#086632; }
    .sub-item {
      background:#f9fafc; border-radius:10px; padding:10px; margin-bottom:12px;
      box-shadow:inset 0 0 0 1px rgba(0,0,0,0.05);
    }
    .sub-timeline { display:flex; flex-wrap:wrap; gap:4px; margin-top:6px; justify-content:flex-start; }
    .sub-timeline div {
      width:26px; height:26px; border-radius:5px; line-height:26px;
      font-size:0.8rem; color:#fff; cursor:pointer; transition:0.2s;
    }
    .sub-timeline div:hover { transform:scale(1.1); }
    #tablaResumen td { font-size:0.9rem; }
    #tablaResumen th { font-size:0.95rem; }
    #detalleSubprocesos {
      margin-top:20px; background:#f7f9fb; border-radius:10px;
      padding:12px; box-shadow:inset 0 0 0 1px rgba(0,0,0,0.05);
    }
    .subResumenTitulo { margin:10px 0 6px; font-weight:600; color:#0a7b40; }
    .subResumenItem { font-size:0.9rem; margin-left:10px; }
    @media(max-width:800px){ main{padding:12px;} nav{flex-wrap:wrap;gap:8px;} iframe{height:820px!important;} }
  </style>
</head>
<body>
  <header>
    <div class="panel-logo">
      <img id="logoUsuario" src="" alt="Logo Usuario">
      <h1 style="color:#0a7b40">SIGAPH — Panel de Aliados</h1>
    </div>
    <div style="text-align:right">
      <div id="bienvenida" style="margin-bottom:6px"></div>
      <button id="cerrarSesion" class="logout-btn">Cerrar sesión</button>
    </div>
  </header>

  <nav>
    <button onclick="mostrarSeccion('inicio')">Inicio</button>
    <button onclick="mostrarSeccion('reporte')">Generar Reporte</button>
    <button onclick="mostrarSeccion('control')">Control de Aliados</button>
    <button id="btnSolicitudes" style="display:none" onclick="mostrarSeccion('solicitudes')">Solicitudes de Visitas</button>
    <button id="btnLinea" style="display:none" onclick="mostrarSeccion('linea')">Línea de Tiempo</button>
  </nav>

  <main>
    <section id="inicio" class="activo">
      <img id="logoCentral" src="" alt="Logo central">
      <h2 class="center">Bienvenido al Panel</h2>
    </section>

    <section id="reporte">
      <h2 class="center">Generar Reporte</h2>
      <div style="max-width:950px;margin:auto;">
        <iframe src="https://docs.google.com/forms/d/e/1FAIpQLSe2l1I7ZkyPesXxULiuM27ILql3F4WuZjAKowacitFStuHCJA/viewform?embedded=true" width="100%" height="1550"></iframe>
      </div>
    </section>

    <section id="control">
      <h2 class="center">Control de Aliados</h2>
      <div id="reporteSigaph" style="display:none; margin-top:20px;">
        <iframe src="https://docs.google.com/spreadsheets/d/1ksfjkGYY7WXh-FYAJ6TC2l1T8cja_XCanY8wPq_Bcrg/edit?usp=drive_link&widget=true&headers=false" width="100%" height="750"></iframe>
      </div>
    </section>

    <section id="linea">
      <h2 class="center">Línea de Tiempo — Seguimiento Detallado</h2>
      <div class="timeline-container">
        <div class="timeline-tabs" id="timelineTabs"></div>
        <div id="timelineContent">
          <h3 id="timelineTitle" class="center">Seleccione un subproceso</h3>
          <div id="timelineCompact" class="timeline-compact"></div>

          <div class="timeline-controls">
            <label>Fase actual:</label>
            <select id="faseSelect">
              <option value="0">Seleccione fase</option>
              <option value="1">1. Diagnóstico</option>
              <option value="2">2. Informe preliminar</option>
              <option value="3">3. Informe aliado</option>
              <option value="4">4. Cotización</option>
              <option value="5">5. Enviado cliente</option>
              <option value="6">6. Espera</option>
              <option value="7">7. Seguimiento</option>
              <option value="8">8. Toc toc</option>
              <option value="9">9. Resultado</option>
              <option value="10">10. Finalizado</option>
            </select>
            <label>Resultado:</label>
            <select id="resultadoSelect">
              <option value="">Sin resultado</option>
              <option value="aprobado">Aprobado</option>
              <option value="rechazado">Rechazado</option>
            </select>
            <textarea id="observaciones" rows="3" placeholder="Observaciones..."></textarea>
            <button id="guardarFase">Guardar Avance</button>
            <button id="nuevoSub">Agregar Subproceso</button>
          </div>

          <div class="subprocesos-area" id="subArea"></div>

          <div id="listadoGeneral" style="margin-top:25px;">
            <h3 class="center">Resumen General</h3>
            <table id="tablaResumen">
              <thead><tr><th>#</th><th>Cliente / Unidad</th><th>Fase</th><th>Subprocesos</th><th>Avance</th></tr></thead>
              <tbody></tbody>
            </table>
            <div id="detalleSubprocesos"></div>
          </div>
        </div>
      </div>
    </section>

    <section id="solicitudes">
      <h2 class="center">Solicitudes de Visitas</h2>
      <div style="max-width:1200px;margin:auto;">
        <iframe src="https://docs.google.com/spreadsheets/d/1ObxC_cbiPOW3u4cGLk__7NmrJLIVTagiyy_NJwd1QO8/edit?usp=drive_link&widget=true&headers=false" width="100%" height="750"></iframe>
      </div>
    </section>
  </main>

  <script>
  const auth=JSON.parse(localStorage.getItem('aliado_autenticado')||'null');
  if(!auth)window.location.href='login.html';
  const logoMap={'SIGAPH':'logo_sigaph1.png'};
  document.getElementById('logoUsuario').src=logoMap[auth.username]||'logo_sigaph1.png';
  document.getElementById('logoCentral').src=logoMap[auth.username]||'logo_sigaph1.png';
  document.getElementById('bienvenida').textContent=`Bienvenido, ${auth.username}`;
  if(auth.username==='SIGAPH'){
    document.getElementById('btnSolicitudes').style.display='inline-block';
    document.getElementById('reporteSigaph').style.display='block';
    document.getElementById('btnLinea').style.display='inline-block';
  }
  document.getElementById('cerrarSesion').onclick=()=>{localStorage.removeItem('aliado_autenticado');window.location='login.html';};
  window.mostrarSeccion=id=>{document.querySelectorAll('main section').forEach(s=>s.classList.remove('activo'));document.getElementById(id).classList.add('activo');};

  const fases=[{id:1,color:'#FFD54F'},{id:2,color:'#FFB74D'},{id:3,color:'#BA68C8'},{id:4,color:'#64B5F6'},{id:5,color:'#42A5F5'},{id:6,color:'#9CCC65'},{id:7,color:'#7CB342'},{id:8,color:'#558B2F'},{id:9,color:'#388E3C'},{id:10,color:'#2E7D32'}];
  const tabs=document.getElementById('timelineTabs');
  const title=document.getElementById('timelineTitle');
  const compact=document.getElementById('timelineCompact');
  const faseSel=document.getElementById('faseSelect');
  const resSel=document.getElementById('resultadoSelect');
  const obs=document.getElementById('observaciones');
  const subArea=document.getElementById('subArea');
  const resumen=document.querySelector('#tablaResumen tbody');
  const detalleSub=document.getElementById('detalleSubprocesos');
  let data=JSON.parse(localStorage.getItem('timelineData2')||'{}');
  let actual=null;

  // campo de nombre manual
  const nameInput=document.createElement('input');
  nameInput.type='text';
  nameInput.placeholder='Nombre del cliente o unidad...';
  nameInput.style.cssText='display:none;width:60%;padding:8px;margin:10px auto;display:block;border-radius:8px;border:1px solid #ccc;font-size:1rem;text-align:center;';
  title.parentNode.insertBefore(nameInput,title.nextSibling);

  for(let i=1;i<=20;i++){
    const b=document.createElement('button');
    b.textContent=i;
    b.className='timeline-tab';
    b.onclick=()=>sel(i);
    tabs.appendChild(b);
  }

  function sel(n){
    actual=n;
    [...tabs.children].forEach(b=>b.classList.remove('active'));
    tabs.children[n-1].classList.add('active');

    if(!data[n])data[n]={nombre:'',fase:0,resultado:'',obs:'',subs:[]};
    nameInput.style.display='block';
    nameInput.value=data[n].nombre||'';
    title.textContent=data[n].nombre?`Subproceso ${n} — ${data[n].nombre}`:`Subproceso ${n}`;
    nameInput.oninput=()=>{
      data[n].nombre=nameInput.value.trim();
      save();
      title.textContent=data[n].nombre?`Subproceso ${n} — ${data[n].nombre}`:`Subproceso ${n}`;
      rendResumen();
    };

    faseSel.value=data[n].fase;
    resSel.value=data[n].resultado;
    obs.value=data[n].obs;
    rendCompact(data[n].fase);
    rendSubs(n);
    rendResumen();
  }

  function rendCompact(f){
    compact.innerHTML='';
    for(let i=1;i<=10;i++){
      const d=document.createElement('div');
      d.className='timeline-step-small';
      d.textContent=i;
      d.style.background=f>=i?fases[i-1].color:'#ccc';
      d.onclick=()=>{data[actual].fase=i;save();rendCompact(i);rendResumen();};
      compact.appendChild(d);
    }
  }

  function rendSubs(n){
    subArea.innerHTML='';
    const subs=data[n].subs||[];
    subs.forEach((s,i)=>{
      const div=document.createElement('div');
      div.className='sub-item';
      div.innerHTML=`<strong>${i+1}. ${s.nombre}</strong>`;
      const tl=document.createElement('div');
      tl.className='sub-timeline';
      for(let j=1;j<=10;j++){
        const b=document.createElement('div');
        b.textContent=j;
        b.style.background=s.fase>=j?fases[j-1].color:'#ccc';
        b.onclick=()=>{s.fase=j;save();rendSubs(n);rendResumen();};
        tl.appendChild(b);
      }
      div.appendChild(tl);
      subArea.appendChild(div);
    });
  }

  document.getElementById('guardarFase').onclick=()=>{
    if(!actual)return;
    data[actual].fase=parseInt(faseSel.value);
    data[actual].resultado=resSel.value;
    data[actual].obs=obs.value;
    save();
    rendCompact(data[actual].fase);
    rendResumen();
  };

  document.getElementById('nuevoSub').onclick=()=>{
    if(!actual)return;
    const nom=prompt('Nombre del subproceso');
    if(nom){
      data[actual].subs.push({nombre:nom,fase:0});
      save();
      rendSubs(actual);
      rendResumen();
    }
  };

  function save(){ localStorage.setItem('timelineData2',JSON.stringify(data)); }

  function rendResumen(){
    resumen.innerHTML='';
    detalleSub.innerHTML='';
    for(let i=1;i<=20;i++){
      const d=data[i]||{subs:[]};
      let prom=0;
      if(d.subs.length){prom=d.subs.reduce((a,b)=>a+b.fase,0)/(d.subs.length*10)*100;}
      const nombreMostrado=d.nombre?d.nombre:`Subproceso ${i}`;
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${i}</td><td>${nombreMostrado}</td><td>${d.fase||'-'}</td><td>${d.subs.length}</td><td>${Math.round(prom)}%</td>`;
      resumen.appendChild(tr);
      if(d.subs.length){
        const title=document.createElement('div');
        title.className='subResumenTitulo';
        title.textContent=`${nombreMostrado} — Detalle de Subprocesos:`;
        detalleSub.appendChild(title);
        d.subs.forEach(s=>{
          const pct=Math.round((s.fase/10)*100);
          const line=document.createElement('div');
          line.className='subResumenItem';
          line.textContent=`• ${s.nombre} — ${pct}% completado`;
          detalleSub.appendChild(line);
        });
      }
    }
  }
  sel(1);
  </script>
</body>
</html>
